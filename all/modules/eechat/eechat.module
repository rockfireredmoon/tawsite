<?php

require_once dirname(__FILE__) . '/eechat.common.inc';
require_once dirname(__FILE__) . '/eechat.chat.inc';

/**
 * @file
 * Module file for eechat.
 */


/**
 * Implements hook_permission().
 */
function eechat_permission() {
	return array(
			'view chat' => array(
					'title' => t('View chat'),
					'description' => t('View current chat'),
			),
			'chat' => array(
					'title' => t('Chat'),
					'description' => t('Take part in chat'),
			),
			'shroomies' => array(
					'title' => t('Play Shroomies Search'),
					'description' => t('Allow the mini-game Shroomies Search to be player'),
			),
			'leaderboards' => array(
					'title' => t('View leaderboards'),
					'description' => t('May view leaderboards.'),
			),
			'credit shop' => array(
					'title' => t('View and use creditshop'),
					'description' => t('May view and use the credit shop.'),
			),
			'character details' => array(
					'title' => t('View character details'),
					'description' => t('May view character details.'),
			),
			'guilds' => array(
					'title' => t('View guilds'),
					'description' => t('May view guilds.'),
			),
			'clans' => array(
					'title' => t('View clans'),
					'description' => t('May view clans.'),
			),
	);
}


/**
 * @defgroup eechat Earth Eternal: Block
 * @ingroup earth_eternal
 * @{
 * Blocks for Earth Eternal chat integration.
 */
function eechat_menu() {
	$items ['creditshop'] = array (
			'page callback' => 'eechat_creditshop',
    		'access arguments' => array('credit shop'), 
			'title' => 'Credit Shop',
    		'file' => 'eechat.creditshop.inc'
	);
	
	$items ['leaderboard'] = array (
			'page callback' => 'eechat_leaderboard',
    		'access arguments' => array('leaderboard'), 
			'title' => 'Leaderboard',
    		'file' => 'eechat.stats.inc' 
	);
	
	$items ['character'] = array (
			'page callback' => 'eechat_character',
    		'access arguments' => array('character details'), 
			'title' => 'Character Profile',
    		'file' => 'eechat.stats.inc' 
	);
	
	$items ['clan'] = array (
			'page callback' => 'eechat_clan',
    		'access arguments' => array('clans'),
			'title' => 'Clan Profile',
    		'file' => 'eechat.clans.inc'
	);
	
	$items ['clans'] = array (
			'page callback' => 'eechat_clans',
    		'access arguments' => array('clans'),
			'title' => 'Clans',
    		'file' => 'eechat.clans.inc'
	);
	
	$items ['guild'] = array (
			'page callback' => 'eechat_guild',
    		'access arguments' => array('guilds'),
			'title' => 'Guild Profile',
    		'file' => 'eechat.guilds.inc' 
	);
	
	$items ['guilds'] = array (
			'page callback' => 'eechat_guilds',
    		'access arguments' => array('guilds'),
			'title' => 'Guilds',
    		'file' => 'eechat.guilds.inc' 
	);
	
	$items ['chat'] = array (
			'page callback' => 'drupal_get_form', // this is the function that will be called when the page is accessed. for a form, use drupal_get_form
			'page arguments' => array (
					'eechat_chat_form' 
			), 
    		'access arguments' => array('chat'),
			'title' => 'Chat' ,
    		'file' => 'eechat.chat.inc'
	);
	
	$items ['buy'] = array (
			'page callback' => 'drupal_get_form',
			'page arguments' => array (
					'eechat_buy_form' 
			), 
    		'access arguments' => array('credit shop'),
			'title' => 'Buy Credit Shop Item',
    		'file' => 'eechat.creditshop.inc',
	);
	
	$items ['shroomies-search'] = array (
			'page callback' => 'eechat_shroomies_search',
    		'access arguments' => array('shroomies search'),
			'title' => 'Shroomies Search',
    		'file' => 'eechat.minigames.inc'
	);
	
	$items ['minigame_scores'] = array (
			'page callback' => 'eechat_minigame_scores',
    		'access arguments' => array('shroomies'),
			'title' => 'Minigame Scores',
			'type' => MENU_CALLBACK,
    		'file' => 'eechat.minigames.inc'
	);
	
	return $items;
}


function eechat_block_info() {
	$blocks ['eechat'] = array (
			'info' => t ( 'Earth Eternal Chat' ),
			'cache' => DRUPAL_CACHE_PER_ROLE 
	);
	
	$blocks ['eefullchat'] = array (
			'info' => t ( 'Earth Eternal Full Chat' ),
			'cache' => DRUPAL_CACHE_PER_ROLE 
	);
	
	$blocks ['eewho'] = array (
			'info' => t ( 'Earth Eternal Who' ),
			'cache' => DRUPAL_CACHE_PER_ROLE 
	);
	
	$blocks ['eeaccountinfo'] = array (
			'info' => t ( 'Earth Eternal Account Info' ),
			'cache' => DRUPAL_CACHE_PER_ROLE 
	);
	
	$blocks ['eecurrencyinfo'] = array (
			'info' => t ( 'Block showing players currency (gold and credits)' ),
			'cache' => DRUPAL_CACHE_PER_ROLE 
	);
	
	return $blocks;
}
function eechat_block_configure($delta = '') {
	$form = array ();
	if ($delta == 'eechat' || $delta == 'eefullchat' || $delta == 'eewho' || $delta == 'eeaccountinfo' || $delta == 'eecurrencyinfo') {
		$form ['eechat_url'] = array (
				'#type' => 'textfield',
				'#title' => t ( 'Server API URL' ),
				'#size' => 60,
				'#description' => t ( 'The HTTP API URL of the Planet Forever server. For example http://server.theanubianwar.com/api' ),
				'#default_value' => variable_get ( 'eechat_url', t ( 'http://server.theanubianwar.com/api' ) ) 
		);
	}
	return $form;
}
function eechat_block_save($delta = '', $edit = array()) {
	if ($delta == 'eechat' || $delta == 'eefullchat' || $delta == 'eewho' || $delta == 'eeaccountinfo' || $delta == 'eecurrencyinfo') {
		variable_set ( 'eechat_url', $edit ['eechat_url'] );
	}
}
function eechat_block_view($delta = '') {
	// The $delta parameter tells us which block is being requested.
	switch ($delta) {
		case 'eefullchat' :
		case 'eechat' :
			$block ['subject'] = t ( 'Earth Eternal Chat' );
			$block ['content'] = eechat_contents ( $delta );
			drupal_add_js ( drupal_get_path ( 'module', 'eechat' ) . '/js/eechat.js' );
			break;
		case 'eewho' :
			$block ['subject'] = t ( 'Earth Eternal Who' );
			$block ['content'] = eechat_contents ( $delta );
			drupal_add_js ( drupal_get_path ( 'module', 'eechat' ) . '/js/eewho.js' );
			break;
		case 'eeaccountinfo' :
			$block ['subject'] = t ( 'Earth Eternal Account' );
			$block ['content'] = _render_character_info();
			break;
			/* drupal_add_js(drupal_get_path('module', 'eechat') . '/js/eewho.js'); */
		case 'eecurrencyinfo' :
			$block ['subject'] = t ( 'Your Current Balance' );
			$block ['content'] = _render_purse();
			break;
	}
	return $block;
}
function eechat_contents($which_block) {
	switch ($which_block) {
		
		case 'eewho' :
			list ( $data, $request_headers ) = _doHTTP ( "/who" );
			if (isset ( $request_headers->http_code ) && $request_headers->http_code == 0) {
				$result = array (
						'#markup' => t ( 'Earth Eternal is OFFLINE' ) 
				);
			} else if (isset ( $request_headers->http_code ) && $request_headers->http_code < 300 && $request_headers->http_code >= 200) {
				$who = json_decode ( $data );
				$markup = "<div id=\"block-eechat-eewho-who\">\n<ul>\n";
				foreach ( $who as $name => $info ) {
					$markup = $markup . "<li>" . htmlentities ( $name ) . "</li>\n";
				}
				$markup = $markup . "</ul>\n</div>\n";
				$result = array (
						'#markup' => $markup 
				);
			} else {
				$result = array (
						'#markup' => t ( 'Earth Eternal online player list unavailable. Status %status', array (
								'%status' => $request_headers->http_code 
						) ) 
				);
			}
			return $result;
		
		case 'eechat' :
		case 'eefullchat' :
			return _render_chat_block($which_block);
	}
}

function _render_character_info() {
	global $user;
	$is_player = true;
	$account = $user;
	$req_uri = request_uri ();
	$parts = explode ( "/", $req_uri );
	for($i = 0; $i < count ( $parts ); $i ++) {
		$el = $parts [$i];
		if ($el == "user") {
			if ($i + 1 < count ( $parts )) {
				$el = $parts [$i + 1];
				if (( string ) ( int ) $el == $el) {
					$account = user_load ( $el );
					$is_player = false;
				}
			}
		}
	}
		
	$urlp = "/user/" . urlencode ( $account->name );
	list ( $data, $request_headers ) = _doHTTP ( $urlp );
	$markup = "<div id=\"block-eechat-eeaccountinfo-accountinfo\">\n";
	if (isset ( $request_headers->http_code ) && $request_headers->http_code == 0) {
		$markup = $markup . t ( 'Earth Eternal is OFFLINE' );
	} else if (isset ( $request_headers->http_code ) && $request_headers->http_code < 300 && $request_headers->http_code >= 200) {
		$eeuser = json_decode ( $data );
	
		if ($eeuser->characters != null) {
			$markup = $markup . "<div class=\"account-details\">\n";
			$markup = $markup . "<h2>Account</h2>\n";
				
			$markup = $markup . "<div class=\"last-login\">\n";
			$markup = $markup . "<span class=\"last-login-label player-stat-label\">Last Login</span>\n";
			$markup = $markup . "<span class=\"last-login-value player-stat-value\">" . $eeuser->logon . "</span>\n";
			$markup = $markup . "</div>\n";
				
			$markup = $markup . _get_stats_html ( $eeuser->playerStats );
				
			$markup = $markup . "</div>\n";
			$markup = $markup . "<hr class=\"fancy-small-divider\"/>\n";
			$markup = $markup . "<div class=\"character-details\">\n";
			$markup = $markup . "<h2>Characters</h2>\n";
			$markup = $markup . "<ul>\n";
			foreach ( $eeuser->characters as $character ) {
				$markup = $markup . "<li>\n";
				$markup = $markup . "<span class=\"character-name\"><a href=\"/character/" . urlencode ( $character->name ) . "\">" . $character->name . "</a></span>\n";
				$markup = $markup . "<span class=\"character-level\">Level " . $character->level . "</span>\n";
				$markup = $markup . "<span class=\"character-level\">" . _get_class_name ( $character->profession ) . "</span>\n";
				$markup = $markup . "</li>";
			}
			$markup = $markup . "</ul>\n";
			$markup = $markup . "</div>\n";
		} else {
			$markup = $markup . "<div class=\"no-characters\">\n";
			if ($is_player) {
				$markup = $markup . "You have no characters! <a href=\"/launch\">Play Now</a> to create one.";
			} else {
				$markup = $markup . "Player has no characters.";
			}
			$markup = $markup . "</div>\n";
		}
	} else {
		if ($request_headers->http_code == 404) {
			$markup = $markup . "<div class=\"no-account\">";
			if ($is_player) {
				$markup = $markup . "You have no game account! <a href=\"/launch\">Play Now</a> to create one.";
			} else {
				$markup = $markup . "Player has no characters.";
			}
			$markup = $markup . "</div>\n";
		} else {
			$markup = t ( 'Earth Eternal user not available. ' . $account->name . '. Status %status', array (
					'%status' => $request_headers->http_code
			) );
		}
	}
	$markup = $markup . "</div>\n";
	$result = array (
			'#markup' => $markup
	);
	return $result;
}

/**
* @} End of "defgroup eechat".
*/
